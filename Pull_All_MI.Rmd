---
title: "Pull_All_MI"
output: html_notebook
---

---
title: "All_MI"
output: html_notebook
---
This Notebook pulls data for all Michigan Flows and calculates contacts, responses, a response breakdown, languages, attempts and successes, and opt outs

note: for right now the code only accounts for the first pull being the last in the contacts_variable_report endpoint because that is the only time it came up. will have to add in later for rest of endpoints, but hard to add in right now because don't know what those data would look like.looks like its gonna be a case by case addition for each endpoint
```{r}
library(tidyverse)
library(httr)
library(jsonlite)
library(knitr)
```


Getting Every Flow uuid
```{r}


key<- Sys.getenv("MI_API")
#add_headers(AUTHORIZATION = paste(" Token ", key)))
#get list of flows
flows <-GET("https://app.communityconnectlabs.com/api/v2/flows.json",add_headers(AUTHORIZATION = paste(" Token ", key))) 

#data transformation into a dataframe
flows <- content(flows,"text")
flows <- fromJSON(flows,flatten = TRUE)
flows <- as.data.frame(flows$results)
#separate voice and message flows
message_flows <- flows %>% filter(type=="message")
voice_flows <- flows %>% filter(type=="voice")
#getting rid of unwanted flows
message_flows <- message_flows%>% filter(runs.completed > 0, runs.interrupted > 0)
#all resend? separating looks different
all_resend <- flows %>% filter(name == "all resend")
#a dataframe of just name and flow for adding to other dfs
flow_names <- message_flows %>% select(uuid, name) %>% rename(flow=uuid)
```
Pulling Data for every message flow, "all resend" not included in the loop

Flow Report Endpoint
-used to calculate language_na variable
-Also the framework for every endpoint 
```{r}
#setting variables 
url <- "https://app.communityconnectlabs.com/api/v2/flow_report.json?flow="
last_one <- FALSE # the last data pull for any flow is formatted differently for whatever reason, so this helps avoid errors in data formatting
flow_report <- "nothing right now" #declaring variable before loop, although this might not even be needed in R...same with last_one var
#for loop that pulls data for every flow in message_flows
for(i in 1:nrow(message_flows)){
  #reset last one to false
  last_one <- FALSE
  #make url for getrequest 
url_new <- paste(url,message_flows$uuid[i],sep = "") 
#the get request
temp_fr <- GET(url_new, add_headers(AUTHORIZATION = paste(" Token ", key)))
#in case of timeout errors
if(temp_fr$status_code != 200){
  while(temp_fr$status_code==504){
  print(paste("code 504 timeout: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
    Sys.sleep(5) #wait 5 seconds
  temp_fr <- GET(url_new, add_headers(AUTHORIZATION = paste(" Token ", key))) # try again
} #while 504 bracket
  if(temp_fr$status_code != 504 & temp_fr$status_code != 200){ print(paste("code not 200: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i])) #if the error code was not 504, or 200, then something else went wrong besides a timeout. It would be 200 if we timed out, and then got a successful pull
   print(paste("status code of last response: ", temp_fr$status_code))
     break}#if not 504 bracket
  }#if not 200 bracket
temp_fr<- content(temp_fr,"text")#converting to dataframe from get request
temp_fr<- fromJSON(temp_fr,flatten = TRUE)
if(!is_null(temp_fr[["next"]])){ #check that the nextlink is null, if not there's more to pull than 1 page
 nextlink <- temp_fr[["next"]] #set nextlink for next pull
 counter <- 1 #a counter to see how many pulls 
 temp_fr <- as.data.frame(temp_fr) #make into dataframe
 while(nextlink != "NULL"){ #while nextlink is not null, loop through to get every pull
   to_append <- GET(nextlink, add_headers(AUTHORIZATION = paste(" Token ", key))) #get request
  #this should help with time-outs error 504s same as above check
if(to_append$status_code != 200){while(to_append$status_code==504){
  print(paste("code 504 timeout: ",nextlink," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
  Sys.sleep(5) #wait 5 seconds
  #try again
  to_append <- GET(nextlink, add_headers(AUTHORIZATION = paste(" Token ", key)))
} #while loop 504 bracket
  if(to_append$status_code != 504 & to_append$status_code != 200){ print(paste("code not 200: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
    #if the error code was not 504, or 200, then something else went wrong besides a timeout 
   print(paste("status code of last response: ", to_append$status_code))
    break
    } #if not 504 bracket
  } #if not 200 bracket
   if(to_append$status_code == 200){ #if the pull was successful
   print(paste("success: ", counter)) #print what number pull we just did
   to_append <- content(to_append,"text") #reformatting 
  to_append <- fromJSON(to_append,flatten = TRUE)
  if(is_null(to_append[["next"]])){last_one <- TRUE} #check for last pull of a flow
  if(!last_one){
  to_append <- as.data.frame(to_append) #if not last one, no extra steps needed
  }else{
    print(paste("last one: ", counter+1)) #if last one, print counter,
    to_append <- to_append$results #extra steps to reformat data so it will combine with other data right 
    to_append <- to_append %>% mutate(flow = message_flows$uuid[i], next. = "NULL")
    temp_fr <- temp_fr %>% rename(total_contacts = results.total_contacts, total_completes = results.total_completes, total_expired = results.total_expired, total_interrupts = results.total_interrupts)
  }}
  temp_fr <- bind_rows(temp_fr, to_append) #add last pull into a dataframe
  nextlink <- to_append$next. #update nextlink
  counter <- counter + 1} #update counter
 check <- temp_fr %>% summarise(diff_next = next. != lag(next.)) #this checks that each nextlink was different than the last 
  if(nrow(filter(check,diff_next == FALSE)) != 0){
    print("diff_next test failed") #if it finds two links that were the same stop
    break}
 if(i == 1){ #if first flow, then set flow_report to the df itself,
 flow_report <- temp_fr
 }else{flow_report <- flow_report %>% bind_rows(temp_fr)} #if not first flow, append rows to flow_report
}
 }
flow_rep_copy <- flow_report #make a copy just in event something wrong happens with next steps
flow_report <- flow_report %>% select(-next.) #drop next col
flow_report <- flow_report %>% group_by(flow) %>% summarise_all(funs(sum)) #sum by flow
flow_report <- flow_report %>% left_join(flow_names) #add in flow names 
flow_report_for_csv <- flow_report %>% select(name,total_contacts) %>% rename(total_contacts_USED_FOR_CALCULATING_LANG_NA = total_contacts)#this is what gets put in csv, to explain why some totals add up to more than attempts. more contacts on file for the flow than were attempted to contact it seems for some
```
Contacts Report endpoint
-used for finding opt-out totals
```{r}
url <- "https://app.communityconnectlabs.com/api/v2/contacts_report.json?flow=" #update url
last_one <- FALSE #set variables for pulls
group <- "&group=Opted-Out"
opt_out_report <- "nothing right now" #same thing as above, might not need to be declared 
#pull all data for opt outs
for(i in 1:nrow(message_flows)){
  last_one <- FALSE #update variables and url for optout totals
url_new <- paste(url,message_flows$uuid[i],group, sep = "")
temp_fr <- GET(url_new, add_headers(AUTHORIZATION = paste(" Token ", key))) #get request
#in case of timeout errors or other errors from get request
if(temp_fr$status_code != 200){while(temp_fr$status_code==504){
  print(paste("code 504 timeout: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
  Sys.sleep(5) #wait 5 seconds
  #try again 
  temp_fr <- GET(url_new, add_headers(AUTHORIZATION = paste(" Token ", key)))
}
  if(temp_fr$status_code != 200){ print(paste("code not 200: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
    print(paste("status code of last response: ", temp_fr$status_code))
    break}}
temp_fr<- content(temp_fr,"text") #reformat to df
temp_fr<- fromJSON(temp_fr,flatten = TRUE)
if(!is_null(temp_fr[["next"]])){ #check that next link is null or not to continue on pulling from this flow
 nextlink <- temp_fr[["next"]] #update link and variables
 counter <- 1
 temp_fr <- as.data.frame(temp_fr)
 while(nextlink != "NULL"){ #loop until end of flow 
   to_append <- GET(nextlink, add_headers(AUTHORIZATION = paste(" Token ", key))) #get request 
   #this should help with time-outs error 504s
if(to_append$status_code != 200){while(to_append$status_code==504){
  print(paste("code 504 timeout: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
  Sys.sleep(5)
  #try again 
  to_append <- GET(nextlink, add_headers(AUTHORIZATION = paste(" Token ", key)))
}
  if(to_append$status_code != 504 & to_append$status_code != 200){ print(paste("code not 200: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
     print(paste("status code of last response: ", temp_fr$status_code)) #print was error code was 
    break}}
   if(to_append$status_code == 200){ #successful pull
   print(paste("success: ", counter)) #reformart
   to_append <- content(to_append,"text")
  to_append <- fromJSON(to_append,flatten = TRUE)
  if(is_null(to_append[["next"]])){last_one <- TRUE} #check if last pull
  if(!last_one){
  to_append <- as.data.frame(to_append) #if not last one nothing extra
  }else{
    print(paste("last one: ", counter+1)) #extra steps to reformat last pull
    to_append <- to_append$results
    to_append <- to_append %>% mutate(flow = message_flows$uuid[i], next. = "NULL")
  }}
  temp_fr <- bind_rows(temp_fr, to_append) #append to rest
  nextlink <- to_append$next. #update link and counter
  counter <- counter + 1}
 check <- temp_fr %>% summarise(diff_next = next. != lag(next.)) #check that nextlinks were unique
  if(nrow(filter(check,diff_next == FALSE)) != 0){
    print("diff_next test failed") #stop is nextlinks are different
    break}
 if(i == 1){
 opt_out_report <- temp_fr #first flow 
 }else{opt_out_report <- opt_out_report %>% bind_rows(temp_fr)} #append if not first flow 
  }
}
opt_out_copy <- opt_out_report #just in case
opt_out_report <- opt_out_report %>% select(-next.,-group) #reformatting data and summing it up by flow
opt_out_report <- opt_out_report %>% group_by(flow) %>% summarise("Opted-Out" = sum(total_unique_contacts))
opt_out_report <- opt_out_report %>% left_join(flow_names)
```
flow variable report endpoint
```{r}
#reusing temp_fr var name for all endpoints 
url <- "https://app.communityconnectlabs.com/api/v2/flow_variable_report.json"
last_one <- FALSE
FVR_report <- "nothing right now"
#loop through pulls for every flow 
for(i in 1:nrow(message_flows)){
body <- list(flow=message_flows$uuid[i] ,variables =list(emergencybrakes = list(format = "category"),
vaccineinterest= list(format="category"))) #body is needed for post requests 
  last_one <- FALSE
temp_fr <- POST(url, body = body,encode = "json",verbose() ,add_headers(AUTHORIZATION = paste(" Token ", key)))
#this should help with time-outs error 504s
if(temp_fr$status_code != 200){while(temp_fr$status_code==504){
  print(paste("code 504 timeout: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
  Sys.sleep(5) #wait 5 seconds
  #try again 
  temp_fr <-POST(url, body = body,encode = "json",verbose() ,add_headers(AUTHORIZATION = paste(" Token ", key)))
}
  if(temp_fr$status_code != 504 & temp_fr$status_code != 200){ print(paste("code not 200: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
        print(paste("status code of last response: ", temp_fr$status_code)) #stop if not a 504 error 
    break}}
temp_fr<- content(temp_fr,"text") #reformat data
temp_fr<- fromJSON(temp_fr,flatten = TRUE)
if(!is_null(temp_fr[["next"]])){
 nextlink <- temp_fr[["next"]] #check for next link and update is there is 
 counter <- 1
 temp_fr <- as.data.frame(temp_fr)
 while(nextlink != "NULL"){ #loop through this flow 
   to_append <- POST(nextlink, body = body,encode = "json", add_headers(AUTHORIZATION = paste(" Token ", key)))
   #this should help with time-outs error 504s
if(to_append$status_code != 200){while(to_append$status_code==504){
  print(paste("code 504 timeout: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
  Sys.sleep(5) #wait 5 seconds 
  #try again 
  to_append <- POST(nextlink, body = body,encode = "json", add_headers(AUTHORIZATION = paste(" Token ", key)))
}
  if(to_append$status_code != 504 & to_append$status_code != 200){ print(paste("code not 200: ",url_new," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
        print(paste("status code of last response: ", temp_fr$status_code)) #stop if not a timeout error
    break}}
   if(to_append$status_code == 200) #successful pull
   print(paste("success: ", counter))
   to_append <- content(to_append,"text") #reformat data
  to_append <- fromJSON(to_append,flatten = TRUE)
  if(is_null(to_append[["next"]])){last_one <- TRUE}
  if(!last_one){
  to_append <- as.data.frame(to_append)
  }else{
    print(paste("last one: ", counter+1)) #extra steps for last pull
    to_append <- to_append$results
    to_append <- to_append %>% mutate(flow = message_flows$uuid[i], next. = "NULL")
   colnames(temp_fr) <- colnames(temp_fr) %>%  str_replace(pattern ="results.","")  #rename columns to get same names as last pull and rest of pulls
   to_append <- to_append %>% relocate(flow,next.) #reformatting and changing column names
   colnames(to_append) <- colnames(to_append) %>% str_replace(pattern = " ", ".")
  }
  temp_fr <- bind_rows(temp_fr, to_append) #append data and update link and counter
  nextlink <- to_append$next. 
  counter <- counter + 1}
 check <- temp_fr %>% summarise(diff_next = next. != lag(next.)) #check that each link was different.
  if(nrow(filter(check,diff_next == FALSE)) != 0){
    print("diff_next test failed: ") #stop if had same nextlinks
    print(message_flows$uuid[i])
    print(counter)
    break}
 if(i == 1){
 FVR_report <- temp_fr #save flow into df 
 }else{FVR_report <- FVR_report %>% bind_rows(temp_fr)} #append data if not first pull
  }
}
FVR_copy <- FVR_report #copy in case 
FVR_report <- FVR_report %>% select(-next., -starts_with("var")) #drop unneeded columns
FVR_report <- FVR_report %>% group_by(flow) %>% summarise_all(funs(sum)) #sum all
FVR_report <- FVR_report %>% left_join(flow_names) #reformat data and add in names 
FVR_report <- FVR_report %>% relocate(flow,name)
```
Contact variable report endpoint 
```{r}
#contact_variable_report
url <- "https://app.communityconnectlabs.com/api/v2/contact_variable_report.json" #setting variables
last_one <- FALSE
CVR_report <- "nothing right now"
#loop through all pulls 
for(i in 1:nrow(message_flows)){
body <- list(flow=message_flows$uuid[i] ,variables =list(lang = list(format = "category"))) #body for POST request
last_one <- FALSE
temp_fr <- POST(url, body = body,encode = "json", add_headers(AUTHORIZATION = paste(" Token ", key))) #post request
#this should help with time-outs error 504s
if(temp_fr$status_code != 200){while(temp_fr$status_code==504){
  print(paste("code 504 timeout: ",url," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
  Sys.sleep(5) #wait 5 seconds
  #try again 
  temp_fr <- POST(url, body = body,encode = "json", add_headers(AUTHORIZATION = paste(" Token ", key)))
}
  if(temp_fr$status_code != 504& temp_fr$status_code != 200){ print(paste("code not 200: ",url," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
        print(paste("status code of last response: ", temp_fr$status_code)) #stop if not a timeout error
    break}}
temp_fr<- content(temp_fr,"text") #reformat data 
temp_fr<- fromJSON(temp_fr,flatten = TRUE)
if(!is_null(temp_fr[["next"]])){ #check for and get nextlinks
 nextlink <- temp_fr[["next"]]
 counter <- 1
 temp_fr <- as.data.frame(temp_fr)
 #rename columns, everytime because of irregularity in data pulls
  colnames(temp_fr) <- colnames(temp_fr) %>%  str_replace(pattern ="results.","")
 while(nextlink != "NULL"){ #pull all data for this flow
   to_append <- POST(nextlink, body = body, encode = "json", add_headers(AUTHORIZATION = paste(" Token ", key)))
   #this should help with time-outs error 504s
if(to_append$status_code != 200){while(to_append$status_code==504){
  print(paste("code 504 timeout: ",url," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
  Sys.sleep(5) #wait 5 seconds
  #try again 
  to_append <- POST(nextlink, body = body,encode = "json", add_headers(AUTHORIZATION = paste(" Token ", key)))
}
  if(to_append$status_code != 504 & to_append$status_code != 200){ print(paste("code not 200: ",url," flow: ", message_flows$uuid[i], " ", message_flows$name[i]))
        print(paste("status code of last response: ", temp_fr$status_code)) #stop if not 504 error
    break}}
  if(to_append$status_code == 200)
   print(paste("success: ", counter))
   to_append <- content(to_append,"text")
  to_append <- fromJSON(to_append,flatten = TRUE)
  #last one check
  if(is_null(to_append[["next"]])){last_one <- TRUE}
  if(!last_one){
  to_append <- as.data.frame(to_append) 
  colnames(to_append) <- colnames(to_append) %>% str_replace(pattern ="results.","") #rename every time
  }else{
    print(paste("last one: ", counter+1))#additional steps for last pull
    #additional code for renaming
    to_append <- to_append$results
    to_append <- to_append %>% mutate(flow = message_flows$uuid[i], next. = "NULL", key = "lang")
   to_append <- to_append %>% relocate(flow,next.)
   colnames(to_append) <- colnames(to_append) %>% str_replace(pattern = " ", ".")
  }
  
  temp_fr <- bind_rows(temp_fr, to_append) #append data and update link and counter
  nextlink <- to_append$next.
  counter <- counter + 1}
 check <- temp_fr %>% summarise(diff_next = next. != lag(next.))
  if(nrow(filter(check,diff_next == FALSE)) != 0){ #check for different links
    print("diff_next test failed: ")
    print(message_flows$uuid[i])
    print(counter)
    break}
}#
else{ #if the first pull is the last pull
  counter <- 1
    print(paste("last one: ", counter))
    #additional code for renaming
    temp_fr <- temp_fr$results
    temp_fr <- temp_fr %>% mutate(flow = message_flows$uuid[i], next. = "NULL",key="lang")
    if(ncol(temp_fr)==5){
   colnames(temp_fr) <- c("next.","flow","key","lang.eng","lang.spa")}
   colnames(temp_fr) <- colnames(temp_fr) %>%  str_replace(pattern ="results.","")
}
 if(i == 1){
 CVR_report <- temp_fr #save or append data if first of not first flow
 }else{CVR_report <- CVR_report %>% bind_rows(temp_fr)}

}
CVR_copy <- CVR_report #copy in case
CVR_report <- CVR_report %>% select(-next.,-key) #drop unneeded columns
CVR_report <- CVR_report %>% transmute_all(~replace(.,is.na(.),0)) #replace NA with 0
CVR_report <- CVR_report %>% group_by(flow) %>% summarise_all(funs(sum)) #sum up and add names
CVR_report <- CVR_report %>% left_join(flow_names)


```
Calculating Metrics
```{r}
#joining data into one 
all_data <- left_join(flow_report,opt_out_report)
all_data <- left_join(all_data,FVR_report) %>% left_join(CVR_report)
all_data <- all_data %>% relocate(name,flow, total_contacts)

#don't need percentages
#calculate attempts by adding emer brakes other and stop, successful is other 
 attempts <- all_data %>% summarise(attempts = .$emergencybrakes.Other+.$emergencybrakes.STOP, successful_attempts_count = .$emergencybrakes.Other, name = name)
 #calculate languages 
language <- all_data %>% summarise(lang_eng = lang.eng, lang_spa = lang.spa, lang_NA = .$total_contacts - lang.eng- lang.spa, name=name)
#calculate total responses
 survey_response <- all_data %>% summarise(number_responses = vaccineinterest.Spanish+vaccineinterest.Yes+vaccineinterest.Probably.not+vaccineinterest.No+vaccineinterest.Probably.yes+vaccineinterest.Not.sure+vaccineinterest.Already.Vax+vaccineinterest.Other,name=name)
#separate individual responses
response_breakdown <- all_data %>% summarise(response_already_vax = vaccineinterest.Already.Vax, response_no = vaccineinterest.No, response_other = vaccineinterest.Other, response_yes = vaccineinterest.Yes, response_not_sure = vaccineinterest.Not.sure, response_probably_not=vaccineinterest.Probably.not, response_probably_yes = vaccineinterest.Probably.yes, response_spanish = vaccineinterest.Spanish, name =name)
#opt out totals 
opt_outs <- all_data %>% summarise(opt_outs_count = .$`Opted-Out`, name=name)  
#join all the calculations and wanted totals in one df
all_metrics <- left_join(attempts,language) %>% left_join(survey_response) %>% left_join(response_breakdown) %>% left_join(opt_outs) %>% left_join(flow_report_for_csv) %>% relocate(name, total_contacts_USED_FOR_CALCULATING_LANG_NA)

#save metrics as csv
write_csv(all_metrics, paste("mi_sends_metrics_all", Sys.Date(), ".csv",sep = "_"))

```
